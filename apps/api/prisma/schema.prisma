generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

// ENUMS
enum UserRole {
  CLIENT
  WORKER
  ADMIN
}

enum UserStatus {
  ANON
  LOGGED_IN
  BLOCKED
  DEBTOR
}

enum WorkerStatus {
  ONLINE
  PAUSED
  OFFLINE
  ON_JOB
}

enum JobStatus {
  CREATED
  ACCEPTED
  ASSIGNED
  IN_PROGRESS
  PENDING_CLIENT_APPROVAL
  COMPLETED
  CANCELLED
  DISPUTED
  UNDER_REVIEW
  RESOLVED
}

enum KYCStatus {
  PENDING_SUBMISSION
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum ExtraTimeStatus {
  NONE
  PENDING
  APPROVED
  REJECTED
}

enum TargetAudience {
  WORKER
  CLIENT
}

enum TransactionType {
  ESCROW_ALLOCATION
  ESCROW_RELEASE
  WITHDRAWAL
  REFUND
  PAYOUT
  DISPUTE_REFUND
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
  FAILED
}

enum ActiveRole {
  CLIENT
  PROVIDER
}

enum SpecialtyStatus {
  DRAFT
  PENDING
  ACTIVE
  REJECTED
}

// DEPRECATED: Use ServiceCategory model instead
enum ServiceCategoryEnum {
  MAINTENANCE
  PAINTING
  HVAC
  ELECTRICAL
  PLUMBING
}

enum ServiceSubcategory {
  // MAINTENANCE
  LAWN_MOWING
  GARDEN_CLEANUP
  TREE_TRIMMING
  PRESSURE_WASHING

  // PAINTING
  INTERIOR_PAINTING
  EXTERIOR_PAINTING
  WALL_REPAIR

  // HVAC
  AC_INSTALLATION
  AC_REPAIR
  AC_MAINTENANCE
  HEATING_INSTALLATION

  // ELECTRICAL
  OUTLET_INSTALLATION
  LIGHTING_INSTALLATION
  CIRCUIT_BREAKER
  WIRING_REPAIR

  // PLUMBING
  LEAK_REPAIR
  PIPE_INSTALLATION
  DRAIN_CLEANING
  FAUCET_INSTALLATION
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
  EXPERT
}

// ============================================
// CORE USER MODELS
// ============================================

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String
  roles        UserRole[] // Multiple roles support (CLIENT, WORKER, ADMIN)
  currentRole  UserRole   @default(CLIENT) // Persistent current role for consistency
  status       UserStatus @default(LOGGED_IN)
  activeRole   ActiveRole @default(CLIENT) // Active UI context (CLIENT or PROVIDER)

  // Email Verification (Security)
  isEmailVerified        Boolean   @default(false)
  emailVerificationToken String?
  emailVerifiedAt        DateTime?

  // Mercado Pago integration fields
  mercadopagoCustomerId  String? // For clients (payers)
  mercadopagoAccessToken String? // For workers (receivers)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  workerProfile   WorkerProfile?
  clientProfile   ClientProfile?
  customerProfile CustomerProfile? // Perfil para clientes/compradores

  // Mensajes relacionados al User directamente
  sentMessages     ChatMessage[] @relation("SenderRelation")
  receivedMessages ChatMessage[] @relation("ReceiverRelation")

  wallet         Wallet?
  payoutRequests PayoutRequest[]
  userConsents   UserConsent[]
  notifications  Notification[]

  @@index([email])
  @@index([status])
  @@index([activeRole])
  @@index([currentRole])
}

model WorkerProfile {
  id                 String       @id @default(uuid())
  userId             String       @unique
  name               String
  bio                String?
  trade              String? // Oficio (Plomero, Electricista, etc.) - DEPRECATED, use specialties
  hourlyRate         Float? // Precio por hora
  availability       Json? // Estructura flexible para horarios
  rating             Float        @default(5.0)
  totalJobs          Int          @default(0)
  status             WorkerStatus @default(OFFLINE)
  // location           Unsupported("geography(Point, 4326)")? // Commented: Use latitude/longitude instead
  latitude           Float?
  longitude          Float?
  lastLocationUpdate DateTime?
  reputationPoints   Int          @default(0)
  currentPlan        String       @default("STARTER")
  acceptanceRate     Float        @default(1.0)
  cancellationRate   Float        @default(0.0)
  penaltyUntil       DateTime?

  // KYC Fields (Know Your Customer - Regulatory Compliance)
  kycStatus      KYCStatus @default(PENDING_SUBMISSION)
  isKycVerified  Boolean   @default(false) // Calculated field for quick checks
  legalName      String? // Full legal name from ID
  taxId          String? // DNI / Tax ID number
  dateOfBirth    DateTime? // For age verification
  dniFront       String? // ID front image URL
  dniBack        String? // ID back image URL
  insuranceDoc   String? // Insurance document URL
  selfie         String? // Selfie for identity verification
  kycSubmittedAt DateTime? // When KYC was submitted
  kycApprovedAt  DateTime? // When KYC was approved

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Restrict)
  serviceRequests   ServiceRequest[]   @relation("WorkerServiceRequests")
  reviewsGiven      Review[]           @relation("ReviewAuthor")
  reviewsReceived   Review[]           @relation("ReviewTarget")
  workerSpecialties WorkerSpecialty[]  // N:M relationship with ServiceCategory
  // @@index([location]) // Removed: location field is now commented out

  @@index([userId])
  @@index([status])
  @@index([currentPlan])
}

model ClientProfile {
  id               String   @id @default(uuid())
  userId           String   @unique
  name             String
  rating           Float    @default(5.0)
  loyaltyPoints    Int      @default(0)
  reputationPoints Int      @default(0)
  currentPlan      String   @default("CLIENT_BASIC")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Restrict)
  serviceRequests ServiceRequest[] @relation("ClientServiceRequests")

  @@index([userId])
  @@index([currentPlan])
}

model CustomerProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  name          String
  bio           String?
  phone         String?
  avatar        String?
  rating        Float    @default(5.0)
  totalOrders   Int      @default(0)
  loyaltyPoints Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// SERVICE REQUEST & BILLING
// ============================================

// Service Category (Dynamic DB-driven model)

model ServiceCategory {
  id             String           @id @default(uuid())
  slug           String           @unique
  name           String
  iconName       String
  description    String?
  // Usamos Decimal para precisión financiera en producción
  basePrice      Decimal          @db.Decimal(10, 2)
  hourlyRate     Decimal          @db.Decimal(10, 2)
  estimatedHours Float
  active         Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  services          ServiceRequest[]  @relation("ServiceCategoryRelation")
  serviceFormulas   ServiceFormula[]
  workerSpecialties WorkerSpecialty[] // N:M relationship with WorkerProfile
  reviews           Review[]          // Reviews linked to this category

  @@index([slug])
  @@index([active])
  @@map("service_categories")
}

// WorkerSpecialty - Intermediate table for N:M relationship
// Allows workers to have multiple specialties (oficios)
model WorkerSpecialty {
  id              String          @id @default(uuid())
  workerId        String
  categoryId      String
  status          SpecialtyStatus @default(PENDING)
  experienceYears Int             @default(0)
  metadata        Json?           // Certifications, specific skills, etc.
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  worker          WorkerProfile   @relation(fields: [workerId], references: [id], onDelete: Cascade)
  category        ServiceCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  @@unique([workerId, categoryId]) // A worker can only have one entry per category
  @@index([workerId])
  @@index([categoryId])
  @@index([status])
  @@map("worker_specialties")
}

// Service Formula (DB-driven pricing formulas)
model ServiceFormula {
  id                String             @id @default(uuid())
  // Se recomienda usar String si el Enum da problemas en migraciones complejas, 
  // o asegurar que el Enum existe antes de esta tabla.
  subcategory       ServiceSubcategory @unique
  serviceCategoryId String?
  baseTimeFormula   String             // Recomendación: Almacenar como String descriptivo
  defaultMetadata   Json?              
  active            Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  serviceCategory   ServiceCategory?   @relation(fields: [serviceCategoryId], references: [id], onDelete: SetNull)

  @@index([subcategory])
  @@index([active])
  @@index([serviceCategoryId])
  @@map("service_formulas")
}

// Difficulty Multipliers (DB-driven configuration)
model DifficultyMultiplier {
  id        String          @id @default(uuid())
  level     DifficultyLevel @unique
  value     Float
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([level])
}

// Extras Multipliers (DB-driven configuration)
model ExtrasMultiplier {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  value     Float
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([active])
}

model ServiceRequest {
  id                String               @id @default(uuid())
  status            JobStatus            @default(CREATED)
  paymentStatus     String               @default("PENDING") 
  
  subcategory       ServiceSubcategory?
  metadata          Json? 
  difficultyLevel   DifficultyLevel      @default(MEDIUM)
  serviceCategoryId String?

  clientId          String
  workerId          String?
  latitude          Float
  longitude         Float
  address           String?
  city              String?
  coverageRadius    Float                @default(15.0)
  description       String?
  squareMeters      Float
  gardenImageBefore String
  gardenImageAfter  String?
  evidenceImages    String[]
  difficulty        Float                @default(1.0)
  estimatedHours    Float
  aiReasoning       String?
  
  // Estructura de precio recomendada
  price             Json                 // { total, workerNet, platformFee, taxes, currency }
  priceWorkerNet    Decimal?             @db.Decimal(10, 2)
  pricePlatformFee  Decimal?             @db.Decimal(10, 2)
  
  pin               String               @default("0000")
  extraTimeStatus   ExtraTimeStatus      @default(NONE)
  extraTimeMinutes  Int?
  extraTimeReason   String?
  paidAt            DateTime?

  createdAt         DateTime             @default(now())
  startedAt         DateTime?
  completedAt       DateTime?
  warrantyExpiresAt DateTime?

  // Relations
  client            ClientProfile        @relation("ClientServiceRequests", fields: [clientId], references: [id], onDelete: Restrict)
  worker            WorkerProfile?       @relation("WorkerServiceRequests", fields: [workerId], references: [id], onDelete: SetNull)
  serviceCategory   ServiceCategory?     @relation("ServiceCategoryRelation", fields: [serviceCategoryId], references: [id], onDelete: SetNull)
  dispute           Dispute?

  reviews           Review[]
  supportTickets    SupportTicket[]
  transactions      Transaction[]
  chatMessages      ChatMessage[]

  @@index([status])
  @@index([paymentStatus])
  @@index([clientId])
  @@index([workerId])
  @@index([serviceCategoryId])
  @@index([createdAt])
  @@map("service_requests")
}

model Dispute {
  id                String    @id @default(uuid())
  serviceRequestId  String    @unique
  reason            String
  resolution        String?
  resolutionComment String?
  aiAuditScore      Float?
  createdAt         DateTime  @default(now())
  resolvedAt        DateTime?

  // Relations - Dispute es el dueño de la relación 1:1
  serviceRequest ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)

  @@index([createdAt])
}

// ============================================
// WALLET & BILLING
// ============================================

model Wallet {
  id               String   @id @default(uuid())
  userId           String   @unique
  balancePending   Decimal  @default(0) @db.Decimal(14, 2)
  balanceAvailable Decimal  @default(0) @db.Decimal(14, 2)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  user           User            @relation(fields: [userId], references: [id], onDelete: Restrict)
  transactions   Transaction[]
  payoutRequests PayoutRequest[]

  // Billing performance indices
  @@index([userId])
  @@index([updatedAt]) // For recent wallet activity queries
}

model Transaction {
  id             String            @id @default(uuid())
  walletId       String
  jobId          String?
  type           TransactionType
  amount         Decimal           @db.Decimal(14, 2)
  status         TransactionStatus @default(PENDING)
  description    String?
  referenceId    String?
  idempotencyKey String?           @unique
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  // Relations
  wallet         Wallet          @relation(fields: [walletId], references: [id], onDelete: Restrict)
  serviceRequest ServiceRequest? @relation(fields: [jobId], references: [id], onDelete: SetNull)

  // Billing performance indices
  @@index([walletId]) // Quick lookup of wallet transactions
  @@index([jobId]) // Fast service request transaction lookups
  @@index([type]) // Filter by transaction type (PAYMENT_RECEIVED, REFUND, etc.)
  @@index([status]) // Query pending/completed transactions
  @@index([referenceId]) // Idempotency: find transaction by payment gateway ID
  @@index([createdAt]) // Historical/audit queries
  // Composite index for common billing queries
  @@index([walletId, status, createdAt])
}

model PayoutRequest {
  id          String    @id @default(uuid())
  walletId    String
  userId      String // Añadido para consistencia con el modelo User
  amount      Decimal   @db.Decimal(14, 2)
  cbuAlias    String // CBU or alias for payout
  status      String    @default("REQUESTED") // REQUESTED, PROCESSING, COMPLETED, FAILED
  createdAt   DateTime  @default(now())
  processedAt DateTime?

  // Relations
  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Restrict)
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([walletId])
  @@index([userId])
  @@index([status])
}

// ============================================
// CHAT & COMMUNICATION
// ============================================

model ChatMessage {
  id         String   @id @default(uuid())
  jobId      String
  senderId   String
  receiverId String? // Opcional si quieres tracking directo del receptor
  senderRole String?
  content    String
  timestamp  DateTime @default(now())

  // Relations
  job ServiceRequest @relation(fields: [jobId], references: [id], onDelete: Restrict)

  // Relaciones con User (unificadas para evitar conflictos entre perfiles)
  sender   User  @relation("SenderRelation", fields: [senderId], references: [id], onDelete: Restrict)
  receiver User? @relation("ReceiverRelation", fields: [receiverId], references: [id], onDelete: SetNull)

  @@index([jobId])
  @@index([senderId])
  @@index([timestamp])
}

// ============================================
// REVIEWS & SUPPORT
// ============================================

model Review {
  id         String   @id @default(uuid())
  jobId      String
  categoryId String?  // Link to ServiceCategory for category-specific ratings
  rating     Int
  comment    String?
  authorId   String
  targetId   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  job      ServiceRequest   @relation(fields: [jobId], references: [id], onDelete: Restrict)
  category ServiceCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  author   WorkerProfile    @relation("ReviewAuthor", fields: [authorId], references: [id], onDelete: Restrict)
  target   WorkerProfile    @relation("ReviewTarget", fields: [targetId], references: [id], onDelete: Restrict)

  @@index([jobId])
  @@index([authorId])
  @@index([targetId])
  @@index([categoryId])
}

model SupportTicket {
  id          String   @id @default(uuid())
  jobId       String
  reporterId  String
  category    String
  priority    String
  status      String   @default("OPEN")
  subject     String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  job ServiceRequest @relation(fields: [jobId], references: [id], onDelete: Restrict)

  @@index([jobId])
  @@index([reporterId])
  @@index([status])
}

// ============================================
// LEGAL & COMPLIANCE
// ============================================

model LegalDocument {
  id             String         @id @default(uuid())
  targetAudience TargetAudience
  version        String         @unique
  title          String
  content        String
  contentHash    String
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  userConsents UserConsent[]

  @@index([targetAudience])
  @@index([version])
}

model UserConsent {
  id          String   @id @default(uuid())
  userId      String
  documentId  String
  version     String
  contentHash String
  ipAddress   String?
  userAgent   String?
  acceptedAt  DateTime @default(now())

  // Relations
  user     User          @relation(fields: [userId], references: [id], onDelete: Restrict)
  document LegalDocument @relation(fields: [documentId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([documentId])
  @@index([acceptedAt])
}

// ============================================
// CONFIGURATION & SYSTEM
// ============================================

model PlanConfig {
  id             String         @id @default(uuid())
  code           String         @unique
  targetAudience TargetAudience
  name           String
  minPoints      Int            @default(0)
  commissionFee  Float          @default(0.0)
  priorityBonus  Int            @default(0)
  benefits       Json
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([code])
  @@index([targetAudience])
}

model ReputationRule {
  id          String   @id @default(uuid())
  actionKey   String   @unique
  pointsDelta Int
  description String?
  createdAt   DateTime @default(now())

  @@index([actionKey])
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  type      String   @default("STRING")
  updatedAt DateTime @updatedAt

  @@index([key])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String   @default("INFO") // INFO, SUCCESS, WARNING, ERROR
  read      Boolean  @default(false)
  data      Json? // Datos adicionales (deeplink, metadata)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}
